generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SponsorType {
  premium
  goud
  zilver
  brons
}

model Sponsor {
  id         Int         @id @default(autoincrement())
  name       String
  type       SponsorType
  logoUrl    String
  websiteUrl String
  categories String?
  createdAt  DateTime    @default(now())
}

model MatchSchedule {
  id                 Int       @id @default(autoincrement())
  externalId         String    @unique
  date               DateTime
  homeTeamName       String
  awayTeamName       String
  accommodationName  String?
  accommodationRoute String?
  attendanceTime     DateTime?
  isPracticeMatch    Boolean   @default(false)
  isHomeMatch        Boolean   @default(false)
  isCompetitiveMatch Boolean   @default(false)
  fieldName          String?
  refereeName        String?
  reserveRefereeName String?
  homeScore          Int?
  awayScore          Int?
  color              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  roleAssignments MatchRoleAssignment[]
  Production      Production?

  @@index([date])
}

enum Gender {
  male
  female
}

/// Catalog of capabilities (roles) with code and gendered display names
model Capability {
  id           Int      @id @default(autoincrement())
  code         String   @unique // UPPERCASE short code
  functionName String
  nameMale     String
  nameFemale   String
  vMixTitle    Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations
  capabilities       PersonCapability[]
  assignments        MatchRoleAssignment[]
}

/// Catalog of production positions (distinct from capabilities)
model Position {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  createdAt    DateTime @default(now())

  // Relations
  segmentAssignments      SegmentRoleAssignment[]
  callSheetItemPositions  CallSheetItemPosition[]
}

/// People who can be assigned roles in livestream productions
model Person {
  id        Int      @id @default(autoincrement())
  name      String
  gender    Gender
  createdAt DateTime @default(now())

  // Relations
  capabilities       PersonCapability[]
  assignments        MatchRoleAssignment[]
  segmentAssignments SegmentRoleAssignment[]
}

/// Link table: which capabilities a person is capable of fulfilling
model PersonCapability {
  personId     Int
  capabilityId Int
  createdAt    DateTime @default(now())

  person     Person     @relation(fields: [personId], references: [id], onDelete: Cascade)
  capability Capability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  @@id([personId, capabilityId])
}

/// Assignment of a person to a role for a specific match
model MatchRoleAssignment {
  id              Int      @id @default(autoincrement())
  matchScheduleId Int
  personId        Int
  capabilityId    Int
  createdAt       DateTime @default(now())

  matchSchedule MatchSchedule @relation(fields: [matchScheduleId], references: [id], onDelete: Cascade)
  person        Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  capability    Capability    @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  // Prevent exact duplicate assignment of same person to same role in same match
  @@unique([matchScheduleId, capabilityId, personId])
  @@index([matchScheduleId])
  @@index([personId])
  @@index([capabilityId])
}

/// A production instance for a given match
model Production {
  id              Int      @id @default(autoincrement())
  matchScheduleId Int      @unique
  isActive        Boolean  @default(false)
  createdAt       DateTime @default(now())

  matchSchedule MatchSchedule   @relation(fields: [matchScheduleId], references: [id], onDelete: Cascade)
  segments      ProductionSegment[]
  callSheets    CallSheet[]
}

/// Segments within a production (oplopen, wedstrijd, rust, etc.)
model ProductionSegment {
  id             Int        @id @default(autoincrement())
  productionId   Int
  production     Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  naam           String
  volgorde       Int

  // timing
  duurInMinuten  Int
  isTimeAnchor   Boolean    @default(false)

  // Bezetting (assignments) for this segment
  bezetting      SegmentRoleAssignment[]

  // Callsheet items associated with this segment
  callSheetItems CallSheetItem[]

  @@index([productionId])
  @@unique([productionId, volgorde])
}

/// Assignment of a person to a position for a specific production segment
model SegmentRoleAssignment {
  id                  Int               @id @default(autoincrement())
  productionSegmentId Int
  personId            Int
  positionId          Int
  createdAt           DateTime          @default(now())

  productionSegment   ProductionSegment @relation(fields: [productionSegmentId], references: [id], onDelete: Cascade)
  person              Person            @relation(fields: [personId], references: [id], onDelete: Cascade)
  position            Position          @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([productionSegmentId, positionId, personId])
  @@index([productionSegmentId])
  @@index([personId])
  @@index([positionId])
}

/// Clubs participating whose players can be interviewed
model Club {
  id         Int      @id @default(autoincrement())
  name       String
  shortName  String
  slug       String   @unique
  logoUrl    String?
  createdAt  DateTime @default(now())

  players    Player[]
}

/// Players belonging to a club (team roster)
model Player {
  id        Int      @id @default(autoincrement())
  clubId    Int
  name      String
  shirtNo   Int?
  gender    Gender?
  photoUrl  String?
  externalId String?  @unique
  /// Type van persoon binnen teamcontext, zoals 'player' of 'coach'
  personType String?
  /// Functie-omschrijving (bij spelers op basis van gender: Speler/Speelster; bij coaches vanuit API: bijv. Hoofd coach)
  function   String?
  createdAt DateTime @default(now())

  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([name])
}


/// Player images to be used in vMix sponsor rows
model PlayerImage {
  id        Int      @id @default(autoincrement())
  subject   String   // e.g., Jumbo-099 or beer-geluk
  filename  String   // stored file name under uploads/players
  createdAt DateTime @default(now())

  @@index([subject])
}

/// Call sheet for a production
model CallSheet {
  id           Int       @id @default(autoincrement())
  productionId Int
  name         String
  color        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  production   Production   @relation(fields: [productionId], references: [id], onDelete: Cascade)
  items        CallSheetItem[]

  @@index([productionId])
  @@unique([productionId, name])
}

/// Items within a call sheet, linked to a production segment and zero or more positions
model CallSheetItem {
  id                   String   @id // external short id like 0ba22378
  callSheetId          Int
  productionSegmentId  Int
  cue                  String
  title                String
  note                 String?
  color                String?
  timeStart            DateTime?
  timeEnd              DateTime?
  durationSec          Int
  orderIndex           Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  callSheet            CallSheet         @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
  productionSegment    ProductionSegment @relation(fields: [productionSegmentId], references: [id], onDelete: Cascade)
  positions            CallSheetItemPosition[]

  @@index([callSheetId])
  @@index([productionSegmentId])
}

/// Join table assigning positions to a call sheet item
model CallSheetItemPosition {
  callSheetItemId String
  positionId      Int
  createdAt       DateTime @default(now())

  item     CallSheetItem @relation(fields: [callSheetItemId], references: [id], onDelete: Cascade)
  position Position      @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@id([callSheetItemId, positionId])
  @@index([positionId])
}
