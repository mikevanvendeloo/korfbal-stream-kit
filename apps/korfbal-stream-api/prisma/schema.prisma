generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SponsorType {
  premium
  goud
  zilver
  brons
}

model Sponsor {
  id          Int         @id @default(autoincrement())
  name        String
  type        SponsorType
  logoUrl     String
  websiteUrl  String
  categories  String?
  displayName String?
  createdAt   DateTime    @default(now())
}

model MatchSchedule {
  id                 Int       @id @default(autoincrement())
  externalId         String    @unique
  date               DateTime
  homeTeamName       String
  awayTeamName       String
  accommodationName  String?
  accommodationRoute String?
  attendanceTime     DateTime?
  isPracticeMatch    Boolean   @default(false)
  isHomeMatch        Boolean   @default(false)
  isCompetitiveMatch Boolean   @default(false)
  fieldName          String?
  refereeName        String?
  reserveRefereeName String?
  homeScore          Int?
  awayScore          Int?
  color              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  roleAssignments MatchRoleAssignment[]
  Production      Production?

  @@index([date])
}

enum Gender {
  male
  female
}

enum SkillType {
  crew
  on_stream
}

/// Catalog of skills (roles) with code and gendered display names
model Skill {
  id         Int       @id @default(autoincrement())
  code       String    @unique // UPPERCASE short code
  name       String
  nameMale   String
  nameFemale String
  type       SkillType @default(crew)
  createdAt  DateTime  @default(now())

  // Relations
  skills      PersonSkill[]
  assignments MatchRoleAssignment[]
  Position    Position[]

  @@map("Capability")
}

/// Catalog of production positions (distinct from skills)
model Position {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  /// Optional link to a skill that is required for this position
  skillId   Int?
  skill     Skill?   @relation(fields: [skillId], references: [id])
  /// Indicates if this is a studio position (true) or production position (false)
  isStudio  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  segmentAssignments     SegmentRoleAssignment[]
  callSheetItemPositions CallSheetItemPosition[]
  SegmentDefaultPosition SegmentDefaultPosition[]
  productionPositions    ProductionPersonPosition[] // NIEUW: Productie-brede positie toewijzingen
}

/// People who can be assigned roles in livestream productions
model Person {
  id        Int      @id @default(autoincrement())
  name      String
  gender    Gender
  createdAt DateTime @default(now())

  // Relations
  skills              PersonSkill[]
  assignments         MatchRoleAssignment[]
  segmentAssignments  SegmentRoleAssignment[]
  productionPresences ProductionPerson[]
  productionPositions ProductionPersonPosition[] // NIEUW: Productie-brede positie toewijzingen
}

/// Link table: which skills a person has
model PersonSkill {
  personId  Int
  skillId   Int
  createdAt DateTime @default(now())

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  skill  Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([personId, skillId])
  @@map("PersonCapability")
}

/// Assignment of a person to a role for a specific match
model MatchRoleAssignment {
  id              Int      @id @default(autoincrement())
  matchScheduleId Int
  personId        Int
  skillId         Int
  createdAt       DateTime @default(now())

  matchSchedule MatchSchedule @relation(fields: [matchScheduleId], references: [id], onDelete: Cascade)
  person        Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  skill         Skill         @relation(fields: [skillId], references: [id], onDelete: Cascade)

  // Prevent exact duplicate assignment of same person to same role in same match
  @@unique([matchScheduleId, skillId, personId])
  @@index([matchScheduleId])
  @@index([personId])
  @@index([skillId])
}

/// A production instance for a given match
model Production {
  id              Int       @id @default(autoincrement())
  matchScheduleId Int       @unique
  isActive        Boolean   @default(false)
  liveTime        DateTime? // NIEUW: Tijdstip waarop de stream live gaat
  createdAt       DateTime  @default(now())

  matchSchedule       MatchSchedule              @relation(fields: [matchScheduleId], references: [id], onDelete: Cascade)
  segments            ProductionSegment[]
  callSheets          CallSheet[]
  TitleDefinition     TitleDefinition[]
  interviewSubjects   InterviewSubject[]
  productionReport    ProductionReport?
  productionPersons   ProductionPerson[]
  productionPositions ProductionPersonPosition[] // NIEUW: Productie-brede positie toewijzingen
}

/// People marked as present for a production
model ProductionPerson {
  id           Int      @id @default(autoincrement())
  productionId Int
  personId     Int
  createdAt    DateTime @default(now())

  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  person     Person     @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([productionId, personId])
  @@index([productionId])
  @@index([personId])
}

/// NIEUW: Toewijzing van een persoon aan een positie voor de hele productie (standaard)
model ProductionPersonPosition {
  id           Int      @id @default(autoincrement())
  productionId Int
  personId     Int
  positionId   Int
  createdAt    DateTime @default(now())

  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  person     Person     @relation(fields: [personId], references: [id], onDelete: Cascade)
  position   Position   @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([productionId, personId, positionId]) // Een persoon kan een specifieke positie maar één keer hebben per productie
  @@index([productionId])
  @@index([personId])
  @@index([positionId])
}

/// Segments within a production (oplopen, wedstrijd, rust, etc.)
model ProductionSegment {
  id           Int        @id @default(autoincrement())
  productionId Int
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  naam     String
  volgorde Int

  // timing
  duurInMinuten Int
  isTimeAnchor  Boolean @default(false)

  // Bezetting (assignments) for this segment
  bezetting SegmentRoleAssignment[]

  // Callsheet items associated with this segment
  callSheetItems CallSheetItem[]

  @@unique([productionId, volgorde])
  @@index([productionId])
}

/// Configured default positions for a logical segment name (template)
model SegmentDefaultPosition {
  id          Int    @id @default(autoincrement())
  segmentName String
  positionId  Int
  order       Int

  position Position @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([segmentName, order])
  @@index([segmentName])
  @@index([positionId])
}

/// Assignment of a person to a position for a specific production segment
model SegmentRoleAssignment {
  id                  Int      @id @default(autoincrement())
  productionSegmentId Int
  personId            Int
  positionId          Int
  createdAt           DateTime @default(now())

  productionSegment ProductionSegment @relation(fields: [productionSegmentId], references: [id], onDelete: Cascade)
  person            Person            @relation(fields: [personId], references: [id], onDelete: Cascade)
  position          Position          @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([productionSegmentId, positionId, personId])
  @@index([productionSegmentId])
  @@index([personId])
  @@index([positionId])
}

/// Clubs participating whose players can be interviewed
model Club {
  id        Int      @id @default(autoincrement())
  name      String
  shortName String
  slug      String   @unique
  logoUrl   String?
  createdAt DateTime @default(now())

  players Player[]
}

/// Players belonging to a club (team roster)
model Player {
  id         Int      @id @default(autoincrement())
  clubId     Int
  name       String
  shirtNo    Int?
  gender     Gender?
  photoUrl   String?
  externalId String?  @unique
  /// Type van persoon binnen teamcontext, zoals 'player' of 'coach'
  personType String?
  /// Functie-omschrijving (bij spelers op basis van gender: Speler/Speelster; bij coaches vanuit API: bijv. Hoofd coach)
  function   String?
  createdAt  DateTime @default(now())

  club              Club               @relation(fields: [clubId], references: [id], onDelete: Cascade)
  interviewSubjects InterviewSubject[]

  @@index([clubId])
  @@index([name])
}

/// ================= vMix Title Configuration =================

/// Source of data for a title definition
enum TitleSourceType {
  COMMENTARY
  PRESENTATION
  PRESENTATION_AND_ANALIST
  TEAM_COACH
  TEAM_PLAYER
  FREE_TEXT
}

/// Team side selector for parts that need a club context
enum TeamSide {
  HOME
  AWAY
  NONE
}

/// Interview role for explicit selection per team
enum InterviewRole {
  PLAYER
  COACH
}

/// A configurable title definition for a production (or a reusable template when productionId is null)
model TitleDefinition {
  id           Int      @id @default(autoincrement())
  productionId Int?
  name         String
  order        Int      @default(1)
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  production        Production?        @relation(fields: [productionId], references: [id], onDelete: Cascade)
  parts             TitlePart[]
  interviewSubjects InterviewSubject[]

  @@index([productionId, order])
}

/// A part describes how to assemble a definition from various sources
model TitlePart {
  id                Int             @id @default(autoincrement())
  titleDefinitionId Int
  sourceType        TitleSourceType
  teamSide          TeamSide        @default(NONE)
  limit             Int?
  filters           Json?
  /// For FREE_TEXT parts only
  customFunction    String?
  customName        String?

  // Relations
  definition TitleDefinition @relation(fields: [titleDefinitionId], references: [id], onDelete: Cascade)

  @@index([titleDefinitionId])
}

/// Explicit interview subject selection per production & team side (optionally per title)
model InterviewSubject {
  id                Int           @id @default(autoincrement())
  productionId      Int
  side              TeamSide
  role              InterviewRole
  playerId          Int
  titleDefinitionId Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  production      Production       @relation(fields: [productionId], references: [id], onDelete: Cascade)
  player          Player           @relation(fields: [playerId], references: [id], onDelete: Cascade)
  titleDefinition TitleDefinition? @relation(fields: [titleDefinitionId], references: [id])

  // Allow only one selection per production/side/role per specific title. Generic (null titleDefinitionId)
  // duplicates are prevented at API level (partial unique is not supported in Prisma).
  @@unique([productionId, side, role, titleDefinitionId])
  @@index([productionId])
  @@index([playerId])
  @@index([titleDefinitionId])
}

/// Player images to be used in vMix sponsor rows
model PlayerImage {
  id        Int      @id @default(autoincrement())
  subject   String // e.g., Jumbo-099 or beer-geluk
  filename  String // stored file name under uploads/players
  createdAt DateTime @default(now())

  @@index([subject])
}

/// Call sheet for a production
model CallSheet {
  id           Int      @id @default(autoincrement())
  productionId Int
  name         String
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  production Production      @relation(fields: [productionId], references: [id], onDelete: Cascade)
  items      CallSheetItem[]

  @@unique([productionId, name])
  @@index([productionId])
}

/// Items within a call sheet, linked to a production segment and zero or more positions
model CallSheetItem {
  id                  String    @id // external short id like 0ba22378
  callSheetId         Int
  productionSegmentId Int
  cue                 String
  title               String
  note                String?
  color               String?
  timeStart           DateTime?
  timeEnd             DateTime?
  durationSec         Int
  orderIndex          Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  callSheet         CallSheet               @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
  productionSegment ProductionSegment       @relation(fields: [productionSegmentId], references: [id], onDelete: Cascade)
  positions         CallSheetItemPosition[]

  @@index([callSheetId])
  @@index([productionSegmentId])
}

/// Join table assigning positions to a call sheet item
model CallSheetItemPosition {
  callSheetItemId String
  positionId      Int
  createdAt       DateTime @default(now())

  item     CallSheetItem @relation(fields: [callSheetItemId], references: [id], onDelete: Cascade)
  position Position      @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@id([callSheetItemId, positionId])
  @@index([positionId])
}

/// Application-level settings (simple key/value store)
model AppSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ================= Production Report (Livestream Productie Rapport) =================

/// Production report - alleen metadata die niet automatisch te herleiden is
model ProductionReport {
  id           Int        @id @default(autoincrement())
  productionId Int        @unique
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  /// Wedstrijdsponsor (vrij text of sponsor naam)
  matchSponsor String?

  /// Interview spelers argumentatie
  interviewRationale String?

  /// Opmerkingen (vrij tekstveld, meerdere regels)
  remarks String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productionId])
}
