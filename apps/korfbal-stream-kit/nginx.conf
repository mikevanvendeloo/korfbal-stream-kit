server {
    listen 80;
    server_name localhost;

    # Voeg een resolver toe voor dynamische DNS-resolutie binnen Docker
    # 127.0.0.11 is de standaard Docker DNS server
    # valid=5s betekent dat Nginx de DNS-resolutie elke 5 seconden opnieuw probeert
    resolver 127.0.0.11 valid=5s;

    # Extra logging voor debugging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;

    # Dit is de 'root' map waar Nginx de bestanden zoekt.
    # Deze MOET matchen met de COPY-bestemming in je Dockerfile.
    root /usr/share/nginx/html;
    index index.html index.htm;
    # 1. Frontend: React Router ondersteuning
    # Dit is de 'magic' voor React Router / single-page applications (SPA).
    location / {
        # 1. Probeert het bestand $uri (bv. /logo.png) te vinden.
        # 2. Probeert de map $uri/ (bv. /admin/) te vinden.
        # 3. Als beide mislukken, stuur /index.html (de React-app).
        try_files $uri $uri/ /index.html;
    }

    # 2. Proxy alle verzoeken die beginnen met /api, /assets of /uploads naar de backend container
    location ~ ^/(api|assets|uploads)/ {
      # Geen slash aan het einde van de URL!
      # Nginx stuurt /api/persons door als http://korfbal-streamz-api:3333/api/persons
      # Gebruik een variabele om dynamische DNS resolutie te forceren
      set $backend http://korfbal-streamz-api:3333;

      # Log de proxy informatie voor debugging
      add_header X-Debug-Backend $backend always;
      add_header X-Debug-URI $request_uri always;
      add_header X-Proxy-Target $backend always;
      add_header X-Backend-Status $upstream_status always;
      add_header X-Proxy-Time $upstream_response_time always;

      proxy_pass $backend;

      # EssentiÃ«le Headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Goed voor WebSockets (indien je die later gebruikt)
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_cache_bypass $http_upgrade;

      # Extra logging voor errors
      proxy_intercept_errors on;
    }

    # 3. Caching voor assets (alleen voor frontend assets, niet voor proxied assets)
    # We sluiten /assets en /uploads uit van deze regel omdat die nu geproxied worden
    location ~* \.(?:css|js|png|jpg|jpeg|gif|ico|svg)$ {
        # Als het pad begint met /assets of /uploads, laat de proxy regel het afhandelen
        # Dit is een beetje tricky in Nginx, maar de regex location hierboven (met ^/(api|assets|uploads)/)
        # heeft voorrang omdat regex locations in volgorde van definitie worden gecheckt (voor regex)
        # of langste prefix (voor prefix).
        # Echter, ~* is ook een regex.
        # Om conflicten te voorkomen, kunnen we deze regel specifieker maken of vertrouwen op de volgorde.
        # De regel hierboven met ^/(api|assets|uploads)/ is specifieker voor die paden.

        expires 1y;
        add_header Cache-Control "public";
        try_files $uri $uri/ /index.html;
    }
}
